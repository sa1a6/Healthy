<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>حاسبة الوزن الصحي - مطورة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  
  <!-- Google Fonts: Noto Serif Arabic (أنيق للعربية) + Playfair Display (للإنجليزية) + Cairo كاحتياطي -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Arabic:wght@400;600;700&family=Playfair+Display:wght@400;700&family=Cairo:wght@400;600;800&display=swap" rel="stylesheet" />

  <style>
    :root{
      /* أثري مع لمسات دافئة */
      --bg-1: #f7efe1;
      --bg-2: #efe6d1;
      --card: rgba(255,250,243,0.98);
      --accent: #8a5a2b;      /* brown */
      --accent-2: #b77a2b;    /* warm amber */
      --muted: #4b392f;
      --paper-overlay: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><rect width="160" height="160" fill="%23efe6d1"/><g opacity="0.03" fill="%23000000"><path d="M0 0h160v1H0zM0 28h160v1H0zM0 56h160v1H0zM0 84h160v1H0zM0 112h160v1H0zM0 140h160v1H0z"/></g></svg>');
      --glass: rgba(255,255,255,0.55);
      --shadow-1: rgba(80,50,20,0.06);
      --danger: #9a2b2b;
      --success: #2f7a3f;
      --gauge-bg: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,245,238,0.96));
      --btn-focus: 0 10px 30px rgba(138,90,43,0.12);
      --card-deep-shadow: rgba(20,10,6,0.12);
    }

    /* reduce motion preference */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; scroll-behavior: auto !important; }
    }

    /* perspective for subtle 3D */
    body {
      perspective: 1100px;
      /* new elegant font stack: Arabic serif primary, Playfair for Latin, Cairo fallback */
      font-family: 'Noto Serif Arabic', 'Playfair Display', 'Cairo', serif;
      background:
        var(--paper-overlay),
        radial-gradient(900px 400px at 8% 10%, rgba(139,90,43,0.03), transparent 8%),
        radial-gradient(700px 350px at 92% 92%, rgba(183,122,43,0.02), transparent 6%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2));
      padding: 48px 18px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      -webkit-font-smoothing:antialiased;
      color: var(--muted);
    }

    .container {
      max-width: 760px;
      width: 100%;
      background: var(--card);
      padding: 36px 42px;
      border-radius: 18px;
      box-shadow: 0 30px 80px var(--card-deep-shadow), 0 6px 20px var(--shadow-1);
      position: relative;
      transition: box-shadow 0.35s ease, transform 0.45s ease;
      transform-origin: center;
      opacity: 0;
      transform: translateY(18px) scale(.995);
      overflow: visible;
      border: 1px solid rgba(95,60,35,0.06);
      transform-style: preserve-3d; /* for 3D feel */
      backface-visibility: hidden;
      backdrop-filter: blur(4px);
    }

    .container.animate-ready {
      animation: cardIn 640ms cubic-bezier(.2,.9,.3,1) forwards;
    }
    @keyframes cardIn { to { opacity: 1; transform: translateY(0) scale(1); } }

    .container:hover {
      box-shadow: 0 40px 120px rgba(20,10,6,0.18);
      transform: translateY(-8px) rotateX(4deg) rotateY(-3deg) translateZ(6px);
    }

    h2, h5 {
      color: #3f3126;
      font-weight: 700;
      letter-spacing: 0.02em;
      /* ensure headings use the elegant Arabic serif when available */
      font-family: 'Noto Serif Arabic', 'Playfair Display', serif;
    }

    #bmiIntro {
      font-weight: 500;
      color: var(--muted);
      margin-bottom: 18px;
      font-size: 1.05rem;
      opacity: .95;
      transform-origin: right;
    }

    .form-control, .form-select {
      border: 2px solid rgba(138,90,43,0.08);
      background-color: rgba(255,252,247,0.92);
      border-radius: 12px;
      padding: 12px 15px;
      font-size: 1rem;
      transition: border-color 0.25s ease, box-shadow 0.25s ease, transform 0.15s ease;
      box-shadow: 0 6px 14px rgba(0,0,0,0.03) inset;
      color: #3b2e25;
      /* keep input text elegant but readable */
      font-family: 'Cairo', 'Noto Serif Arabic', sans-serif;
    }

    .form-control::placeholder { color: rgba(59,46,37,0.45); }
    .form-control:focus, .form-select:focus {
      border-color: var(--accent);
      box-shadow: var(--btn-focus);
      outline: none;
      transform: translateY(-2px);
    }

    .field-anim { opacity: 0; transform: translateY(8px); }
    .container.animate-ready .field-anim { animation: fieldIn 420ms forwards ease; }
    .container.animate-ready .field-anim:nth-child(1) { animation-delay: 120ms; }
    .container.animate-ready .field-anim:nth-child(2) { animation-delay: 160ms; }
    .container.animate-ready .field-anim:nth-child(3) { animation-delay: 200ms; }
    @keyframes fieldIn { to { opacity: 1; transform: translateY(0);} }

    label > input[type="checkbox"] {
      margin-left: 8px;
      transform: scale(1.18);
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(180deg, var(--accent-2), #7b4b23);
      border: none;
      font-weight: 800;
      padding: 12px 26px;
      border-radius: 12px;
      color: #fff;
      box-shadow: 0 12px 36px rgba(123,75,35,0.16);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter .18s;
      position: relative;
      overflow: hidden;
      transform: translateZ(12px);
      font-family: 'Playfair Display', 'Cairo', serif;
    }
    .btn-primary:active { transform: translateY(1px) scale(.998) translateZ(8px); filter: brightness(.98); }
    .btn-primary:hover { transform: translateY(-4px) translateZ(14px); box-shadow: 0 26px 66px rgba(75,40,20,0.22); }

    .btn-secondary {
      background: linear-gradient(180deg, #fff7ec, #f3e6d3);
      border: 1px solid rgba(106,71,47,0.06);
      font-weight: 700;
      padding: 12px 26px;
      border-radius: 12px;
      color: #6b4f36;
      box-shadow: 0 6px 18px rgba(100,68,46,0.06);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      overflow: hidden;
      transform: translateZ(8px);
      font-family: 'Playfair Display', 'Cairo', serif;
    }
    .btn-secondary:hover { transform: translateY(-3px) translateZ(10px); box-shadow: 0 14px 34px rgba(120,85,50,0.12); }

    /* زر تبديل اللغة — مرفوع للأعلى حتى لا يتداخل مع الصف الأول */
    .btn-info {
      background: linear-gradient(180deg, #3a3640, #111827);
      border: none;
      color: #fff;
      border-radius: 12px;
      font-weight: 700;
      padding: 8px 16px;
      position: absolute;
      top: -18px; /* مرفوع للأعلى */
      left: 18px;
      box-shadow: 0 10px 30px rgba(17,24,39,0.14);
      transition: transform 0.18s ease, background-color 0.18s ease;
      cursor: pointer;
      transform: translateZ(22px);
      z-index: 40; /* أعلى من محتوى الحاوية لتجنب التداخل البصري */
      font-family: 'Playfair Display', 'Cairo', serif;
    }
    .btn-info:active { transform: translateY(1px) translateZ(18px); }
    .btn-info:hover { transform: translateY(-2px) translateZ(24px); }

    .unit-toggle {
      font-size: 0.95rem;
      margin-bottom: 12px;
      color: var(--muted);
      user-select: none;
    }

    /* Note: reduce padding on canvas itself to avoid clientWidth confusion.
       If you want inner white frame, consider wrapping canvas in a div instead. */
    #bmiGauge {
      width: 100%;
      max-width: 360px;
      height: auto;
      margin: 22px auto 10px;
      border-radius: 14px;
      background: var(--gauge-bg);
      /* keep canvas padding 0 so drawing area calculation is simpler */
      padding: 0;
      transition: transform .28s ease, box-shadow .28s ease;
      display: block;
      box-shadow: 0 30px 70px rgba(20,10,6,0.12);
      transform: rotateX(10deg) translateZ(8px);
      border: 1px solid rgba(120,80,45,0.06);
      box-sizing: border-box;
    }
    #bmiGauge:hover { transform: rotateX(8deg) translateZ(10px) scale(1.01); }

    #result {
      font-size: 1.12rem;
      font-weight: 800;
      color: #3b2e25;
      line-height: 1.5;
      margin-top: 12px;
      min-height: 60px;
      transition: transform .3s ease, opacity .3s ease;
      font-family: 'Noto Serif Arabic', 'Playfair Display', serif;
    }

    #tips {
      font-size: 1rem;
      color: var(--muted);
      font-weight: 600;
      margin-top: 10px;
      min-height: 45px;
      user-select: none;
      opacity: .95;
      font-family: 'Noto Serif Arabic', 'Cairo', serif;
    }

    /* Ripple effect element */
    .ripple-effect {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      pointer-events: none;
      opacity: .6;
      animation: ripple 600ms linear;
      background-color: rgba(255,255,255,0.25);
      mix-blend-mode: screen;
    }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }

    .toast-notice {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,247,243,0.98));
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 12px 36px rgba(15,23,42,0.12);
      color: #123431;
      font-weight: 800;
      opacity: 0;
      transform: translateY(12px) scale(.98);
      transition: opacity .28s ease, transform .28s ease;
      z-index: 1200;
      border-left: 6px solid rgba(138,90,43,0.9);
    }
    .toast-notice.show { opacity: 1; transform: translateY(0) scale(1); }

    /* Print area */
    #printContent {
      display:none;
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      padding: 24px;
      color: #5a3e1b;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    #printBody { margin-top: 8px; color: #3f2e20; font-weight:700; }

    #printHeader { display:flex; align-items:center; gap:16px; margin-bottom:10px; justify-content:center; }
    #printHeader img { width:68px; height:68px; border-radius:10px; object-fit:cover; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    #printImages { display:flex; gap:18px; justify-content:center; align-items:center; margin-top:14px; flex-wrap:wrap; }
    #printImages img { max-width:320px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.08); display:block; margin: 0 auto; }

    @media print {
      html[lang="ar"] #printContent { direction: rtl !important; text-align: center !important; }
      html[lang="ar"] #printBody { text-align: right !important; }
      html[lang="ar"] #printHeader h2 { text-align: center !important; }

      html[lang="en"] #printContent { direction: ltr !important; text-align: left !important; }
      html[lang="en"] #printBody { text-align: left !important; }
      html[lang="en"] #printHeader h2 { text-align: left !important; }

      html, body { height: 100%; margin: 0; padding: 0; }
      body {
        background: #fff !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        -webkit-print-color-adjust: exact;
      }

      .container, .btn, form, .unit-toggle, .lang-switch, .toast-notice { display: none !important; }

      #printImages img { page-break-inside: avoid; display:block; margin: 0 auto; }

      @page { size: auto; margin: 18mm; }
    }

    /* small responsive tweaks */
    @media (max-width: 520px) {
      .container { padding: 20px; border-radius: 16px; }
      .btn-primary, .btn-secondary { padding: 10px 18px; }
      #bmiGauge { max-width: 300px; transform: rotateX(8deg) translateZ(6px); }
      .btn-info { top: -12px; left: 12px; } /* مراجعة الموضع على الشاشات الصغيرة */
    }
  </style>
</head>
<body>

<div class="container text-center" role="main" aria-label="حاسبة الوزن الصحي" id="appContainer">
  <button class="btn btn-info lang-switch" onclick="toggleLanguage()" aria-label="تبديل اللغة">English</button>

  <h2 id="title">حاسبة الوزن الصحي</h2>
  <p class="text-muted" id="bmiIntro">مؤشر كتلة الجسم هو مقياس عام لتقييم الوزن نسبةً إلى الطول.</p>

  <!-- وحدة القياس -->
  <div class="unit-toggle text-end" aria-label="تبديل وحدة القياس">
    <label><input type="checkbox" id="unitSwitch" onchange="toggleUnits()"> <span id="unitLabel">استخدام إنش/رطل</span></label>
  </div>

  <form id="bmiForm" onsubmit="return false;" novalidate>
    <div class="mb-3 field-anim"><input type="text" class="form-control" id="name" placeholder="ادخل اسمك" required aria-required="true" aria-label="اسم المستخدم" /></div>
    <div class="mb-3 field-anim"><input type="number" class="form-control" id="age" placeholder="العمر" required aria-required="true" aria-label="العمر" /></div>
    <div class="mb-3 field-anim">
      <!-- language-independent values for gender -->
      <select class="form-select" id="gender" required aria-required="true" aria-label="الجنس">
        <option value="" disabled selected>اختر الجنس</option>
        <option value="male">ذكر</option>
        <option value="female">أنثى</option>
      </select>
    </div>
    <div class="mb-3 field-anim"><input type="number" class="form-control" id="height" placeholder="الطول (سم)" required aria-required="true" aria-label="الطول" /></div>
    <div class="mb-3 field-anim"><input type="number" class="form-control" id="weight" placeholder="الوزن (كجم)" required aria-required="true" aria-label="الوزن" /></div>

    <div class="d-flex justify-content-center gap-3 mb-4 field-anim">
      <button type="button" class="btn btn-primary ripple" onclick="calculateBMI()" id="calcBtn" aria-label="احسب مؤشر كتلة الجسم">احسب</button>
      <button type="button" class="btn btn-secondary ripple" onclick="resetForm()" id="resetBtn" aria-label="إعادة تعيين النموذج">بيانات جديدة</button>
    </div>

    <div class="d-flex justify-content-center gap-3 mt-3" id="printSection" style="display:none;">
      <button type="button" class="btn btn-success ripple" onclick="printResults()" aria-label="طباعة النتائج">طباعة النتائج</button>
    </div>
  </form>

  <div id="result" class="mt-3" aria-live="polite" aria-atomic="true"></div>
  <canvas id="bmiGauge" aria-label="مخطط مؤشر كتلة الجسم" role="img"></canvas>

  <div id="tips" class="mt-3 text-start" aria-live="polite" aria-atomic="true"></div>
</div>

<!-- Toast -->
<div id="toast" class="toast-notice" role="status" aria-live="polite" aria-atomic="true" style="display:none;"></div>

<!-- Print area (centered on page) -->
<div id="printContent" aria-hidden="true">
  <div id="printHeader">
    <div>
      <h2 id="printTitle">نتائج صحية</h2>
      <div style="font-size:14px; color:#6a5d4d; font-weight:600;" id="printMeta"></div>
    </div>
  </div>

  <div id="printBody">
    <p id="printResult" style="font-size:18px;"></p>
    <p id="printTips"></p>
  </div>

  <div id="printImages" aria-hidden="true">
    <img id="printGaugeImg" alt="مؤشر BMI" style="display:none;">
  </div>

  <div style="margin-top:18px; text-align:center; color:#7a6a58; font-weight:700;">
    <span>Generated by Healthy Weight Calculator</span>
  </div>
</div>

<script>
  let currentLang = 'ar';
  let currentGaugeBmi = 0;
  let gaugeAnimationFrame = null;

  const translations = {
    ar: {
      title: "حاسبة الوزن الصحي",
      bmiIntro: "مؤشر كتلة الجسم هو مقياس عام لتقييم الوزن نسبةً إلى الطول.",
      namePlaceholder: "ادخل اسمك",
      agePlaceholder: "العمر",
      genderPlaceholder: "اختر الجنس",
      male: "ذكر",
      female: "أنثى",
      heightPlaceholder: "الطول (سم)",
      weightPlaceholder: "الوزن (كجم)",
      calcBtn: "احسب",
      resetBtn: "بيانات جديدة",
      printBtn: "طباعة النتائج",
      unitSwitch: "استخدام إنش/رطل",
      bmiResult: "مؤشر كتلة الجسم الخاص بك هو: ",
      bmiCategory: "تصنيف الوزن: ",
      tipsTitle: "نصائح:",
      saved: "تمت العملية"
    },
    en: {
      title: "Healthy Weight Calculator",
      bmiIntro: "BMI is a general measure of weight relative to height.",
      namePlaceholder: "Enter your name",
      agePlaceholder: "Age",
      genderPlaceholder: "Select Gender",
      male: "Male",
      female: "Female",
      heightPlaceholder: "Height (cm)",
      weightPlaceholder: "Weight (kg)",
      calcBtn: "Calculate",
      resetBtn: "New Data",
      printBtn: "Print Results",
      unitSwitch: "Use Inch/Pound",
      bmiResult: "Your BMI is: ",
      bmiCategory: "Weight Category: ",
      tipsTitle: "Tips:",
      saved: "Done"
    }
  };

  function updateLanguage() {
    const t = translations[currentLang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('bmiIntro').textContent = t.bmiIntro;
    document.getElementById('name').placeholder = t.namePlaceholder;
    document.getElementById('age').placeholder = t.agePlaceholder;

    // update displayed text for gender options (values remain language-independent)
    const genderSelect = document.getElementById('gender');
    if (genderSelect && genderSelect.options && genderSelect.options.length >= 3) {
      genderSelect.options[0].text = t.genderPlaceholder;
      genderSelect.options[1].text = t.male;
      genderSelect.options[2].text = t.female;
    }

    document.getElementById('height').placeholder = t.heightPlaceholder;
    document.getElementById('weight').placeholder = t.weightPlaceholder;
    document.getElementById('calcBtn').textContent = t.calcBtn;
    document.getElementById('resetBtn').textContent = t.resetBtn;
    const printBtn = document.querySelector('#printSection button');
    if (printBtn) printBtn.textContent = t.printBtn;
    const unitLabel = document.getElementById('unitLabel');
    if (unitLabel) unitLabel.textContent = t.unitSwitch;
    const langBtn = document.querySelector('.lang-switch');
    if (langBtn) langBtn.textContent = currentLang === 'ar' ? 'English' : 'عربي';
  }

  function toggleLanguage() {
    currentLang = currentLang === 'ar' ? 'en' : 'ar';
    document.documentElement.lang = currentLang;
    document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
    const app = document.getElementById('appContainer');
    app.style.transition = 'transform .45s cubic-bezier(.2,.9,.3,1), opacity .35s';
    app.style.transform = 'rotateY(12deg) translateY(-6px)';
    app.style.opacity = '0.92';
    setTimeout(() => {
      updateLanguage();
      app.style.transform = 'rotateY(0deg) translateY(0)';
      app.style.opacity = '1';
    }, 180);
  }

  function toggleUnits() {
    const useImperial = document.getElementById('unitSwitch').checked;
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    if (useImperial) {
      heightInput.placeholder = currentLang === 'ar' ? "الطول (إنش)" : "Height (inch)";
      weightInput.placeholder = currentLang === 'ar' ? "الوزن (رطل)" : "Weight (lbs)";
    } else {
      heightInput.placeholder = currentLang === 'ar' ? "الطول (سم)" : "Height (cm)";
      weightInput.placeholder = currentLang === 'ar' ? "الوزن (كجم)" : "Weight (kg)";
    }
    // clear inputs for clarity when switching units
    heightInput.value = '';
    weightInput.value = '';
    clearResults();
  }

  // تحسين clearResults: يوقف الأنيميشن ويعيد رسم المقياس فوراً
  function clearResults() {
    document.getElementById('result').textContent = '';
    document.getElementById('tips').textContent = '';
    document.getElementById('printSection').style.display = 'none';

    // أوقف أي أنيميشن جارٍ للمؤشر
    if (gaugeAnimationFrame) cancelAnimationFrame(gaugeAnimationFrame);
    gaugeAnimationFrame = null;

    // اضبط الحالة واطلب رسم فوري
    currentGaugeBmi = 0;
    const canvas = document.getElementById('bmiGauge');
    if (canvas) {
      canvas.style.display = 'block'; // تأكد أنه مرئي
      // force layout/read before draw
      void canvas.offsetWidth;
      drawGauge(0); // رسم فوري لقيمة صفر
    }
  }

  // تحسين resetForm: إعادة الضبط + رسم فوري + إعادة رسم بعد تأخير قصير (للتأكد من استقرار الـ layout)
  function resetForm() {
    document.getElementById('bmiForm').reset();
    clearResults();
    showToast(currentLang === 'ar' ? 'تمت إعادة ضبط البيانات' : 'Form reset', 1000);

    // أعد رسم المقياس بعد فترة قصيرة للتعامل مع حالات إعادة التدفق (reflow)
    setTimeout(() => {
      drawGauge(0);
    }, 60);
  }

  async function calculateBMI() {
    const name = document.getElementById('name').value.trim();
    const age = parseInt(document.getElementById('age').value);
    const genderVal = document.getElementById('gender').value; // 'male' | 'female' | ''
    let height = parseFloat(document.getElementById('height').value);
    let weight = parseFloat(document.getElementById('weight').value);
    const useImperial = document.getElementById('unitSwitch').checked;

    if (!name) { alert(currentLang === 'ar' ? "الرجاء إدخال الاسم." : "Please enter your name."); return; }
    if (isNaN(age) || age < 1 || age > 120) { alert(currentLang === 'ar' ? "الرجاء إدخال عمر صحيح بين 1 و 120." : "Please enter a valid age between 1 and 120."); return; }
    if (!genderVal) { alert(currentLang === 'ar' ? "الرجاء اختيار الجنس." : "Please select gender."); return; }
    if (isNaN(height) || height <= 0) { alert(currentLang === 'ar' ? "الرجاء إدخال الطول بشكل صحيح." : "Please enter a valid height."); return; }
    if (isNaN(weight) || weight <= 0) { alert(currentLang === 'ar' ? "الرجاء إدخال الوزن بشكل صحيح." : "Please enter a valid weight."); return; }

    if (useImperial) {
      height = height * 2.54;
      weight = weight * 0.453592;
    }

    const heightM = height / 100;
    const bmi = weight / (heightM * heightM);
    const bmiRounded = parseFloat(bmi.toFixed(1));
    const t = translations[currentLang];

    let category = '';
    let tips = '';
    if (bmi < 18.5) {
      category = currentLang === 'ar' ? "نقص في الوزن" : "Underweight";
      tips = currentLang === 'ar' ? "تناول المزيد من الطعام الصحي وزيادة السعرات الحرارية تدريجياً." : "Eat more healthy foods and gradually increase calories.";
    } else if (bmi < 24.9) {
      category = currentLang === 'ar' ? "وزن طبيعي" : "Normal weight";
      tips = currentLang === 'ar' ? "حافظ على نمط حياة صحي وتوازن في الغذاء." : "Maintain a healthy lifestyle and balanced diet.";
    } else if (bmi < 29.9) {
      category = currentLang === 'ar' ? "زيادة في الوزن" : "Overweight";
      tips = currentLang === 'ar' ? "مارس التمارين بانتظام وراقب نظامك الغذائي." : "Exercise regularly and monitor your diet.";
    } else {
      category = currentLang === 'ar' ? "سمنة" : "Obese";
      tips = currentLang === 'ar' ? "استشر مختصًا وابدأ في تحسين نمط حياتك تدريجياً." : "Consult a specialist and start improving your lifestyle gradually.";
    }

    const calcBtn = document.getElementById('calcBtn');
    calcBtn.disabled = true;
    calcBtn.animate([{ transform: 'scale(1)' }, { transform: 'scale(.98)' }, { transform: 'scale(1)' }], { duration: 420, easing: 'ease-out' });

    animateGaugeTo(bmiRounded);

    setTimeout(() => {
      document.getElementById('result').innerHTML =
        `${t.bmiResult}<span style="color:var(--accent); font-weight:800;">${bmiRounded.toFixed(1)}</span><br>${t.bmiCategory}<span style="color:var(--accent-2); font-weight:800;">${category}</span>`;
      document.getElementById('tips').textContent = tips;
      document.getElementById('printSection').style.display = 'flex';
    }, 260);

    showToast(t.saved);
    setTimeout(()=> { calcBtn.disabled = false; }, 600);
  }

  // تحسين animateGaugeTo: يبدأ برسم الإطار الابتدائي فوراً ثم يقوم بالأنيميشن
  function animateGaugeTo(targetBmi) {
    if (gaugeAnimationFrame) cancelAnimationFrame(gaugeAnimationFrame);
    const duration = 700;
    const start = performance.now();
    const from = currentGaugeBmi || 0;
    const to = Math.min(Math.max(targetBmi, 0), 40);

    // رسم البداية حتى لا يبدو اللوحة فارغة عند بدء الأنيميشن
    drawGauge(from);

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }
    function step(now) {
      const elapsed = now - start;
      const progress = Math.min(elapsed / duration, 1);
      const eased = easeOutCubic(progress);
      currentGaugeBmi = from + (to - from) * eased;
      drawGauge(currentGaugeBmi);
      if (progress < 1) {
        gaugeAnimationFrame = requestAnimationFrame(step);
      } else {
        gaugeAnimationFrame = null;
        currentGaugeBmi = to;
      }
    }
    gaugeAnimationFrame = requestAnimationFrame(step);
  }

  function drawGauge(bmi) {
    const canvas = document.getElementById('bmiGauge');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // حساب الحجم من bounding rect وخصم الحشوة (padding) للحصول على مساحة المحتوى الفعلية
    const rect = canvas.getBoundingClientRect();
    const cs = window.getComputedStyle(canvas);
    const padLeft = parseFloat(cs.paddingLeft) || 0;
    const padRight = parseFloat(cs.paddingRight) || 0;
    const padTop = parseFloat(cs.paddingTop) || 0;
    const padBottom = parseFloat(cs.paddingBottom) || 0;

    // نستخدم أصغر قيمة عرض/ارتفاع حتى يبقى دائريًا
    let availableWidth = Math.max(0, rect.width - (padLeft + padRight));
    let availableHeight = Math.max(0, rect.height - (padTop + padBottom));
    // إذا rect.height صفر (قد يحصل لأن لم يتم تحديد ارتفاع بعد)، استخدم width
    if (!availableHeight) availableHeight = availableWidth;

    // سقف منطقي (كما سابقًا) مع fallback
    let size = Math.min(availableWidth, availableHeight, 360);
    if (!size || size < 60) {
      // fallback to parent width or default
      const parent = canvas.parentElement;
      const parentWidth = parent ? parent.clientWidth : 300;
      size = Math.min(parentWidth, 360);
      if (size < 80) size = 220; // last resort
    }

    // DPR-aware
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.round(size * dpr);
    canvas.height = Math.round(size * dpr);
    // set CSS size to match content area
    canvas.style.width = size + 'px';
    canvas.style.height = size + 'px';

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // scale drawing operations
    ctx.clearRect(0, 0, size, size);

    // background (paper-like)
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size * 0.4, 0, 2 * Math.PI);
    const grad = ctx.createLinearGradient(0,0,size,size);
    grad.addColorStop(0, '#fffefb');
    grad.addColorStop(1, '#fbf6ee');
    ctx.fillStyle = grad;
    ctx.fill();

    // ranges palette (slightly muted earthy)
    const ranges = [
      { start: 0, end: 18.5, color: '#7fb3ff' },  // blue
      { start: 18.5, end: 24.9, color: '#6bbf8f' }, // green
      { start: 24.9, end: 29.9, color: '#f0c36b' }, // amber
      { start: 29.9, end: 40, color: '#f1949b' }    // rose
    ];

    const startAngle = Math.PI * 0.75;
    const totalAngle = Math.PI * 1.5;
    const radius = size * 0.44;

    ranges.forEach(range => {
      let fromAngle = startAngle + totalAngle * (range.start / 40);
      let toAngle = startAngle + totalAngle * (range.end / 40);
      ctx.beginPath();
      ctx.strokeStyle = range.color;
      ctx.lineWidth = Math.max(12, size * 0.08);
      ctx.lineCap = 'round';
      ctx.arc(size / 2, size / 2, radius, fromAngle, toAngle);
      ctx.stroke();
    });

    // ticks
    for (let i=0;i<=10;i++){
      const angle = startAngle + totalAngle * (i/10);
      const inner = radius - size * 0.12;
      const outer = radius + size * 0.02;
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(59,46,37,0.06)';
      ctx.lineWidth = (i%5===0)?2.6:1.4;
      ctx.moveTo(size/2 + inner*Math.cos(angle), size/2 + inner*Math.sin(angle));
      ctx.lineTo(size/2 + outer*Math.cos(angle), size/2 + outer*Math.sin(angle));
      ctx.stroke();
    }

    // needle
    const clampedBmi = Math.min(Math.max(bmi || 0, 0), 40);
    const bmiAngle = startAngle + totalAngle * (clampedBmi / 40);

    ctx.beginPath();
    ctx.strokeStyle = 'rgba(0,0,0,0.08)';
    ctx.lineWidth = Math.max(6, size * 0.02);
    ctx.lineCap = 'round';
    ctx.moveTo(size/2, size/2);
    ctx.lineTo(size/2 + (radius * 0.72)*Math.cos(bmiAngle + 0.01), size/2 + (radius * 0.72)*Math.sin(bmiAngle + 0.01));
    ctx.stroke();

    ctx.beginPath();
    ctx.strokeStyle = 'rgba(138,90,43,0.98)';
    ctx.lineWidth = Math.max(4, size * 0.011);
    ctx.lineCap = 'round';
    ctx.moveTo(size/2, size/2);
    ctx.lineTo(size/2 + (radius * 0.74)*Math.cos(bmiAngle), size/2 + (radius * 0.74)*Math.sin(bmiAngle));
    ctx.stroke();

    ctx.beginPath();
    ctx.fillStyle = 'rgba(138,90,43,1)';
    ctx.arc(size/2, size/2, Math.max(8, size * 0.035), 0, 2*Math.PI);
    ctx.fill();

    // BMI text (use Noto Serif Arabic / Playfair fallback)
    ctx.font = `bold ${Math.max(18, size * 0.11)}px "Noto Serif Arabic", "Playfair Display", serif`;
    ctx.fillStyle = '#3b2e25';
    ctx.textAlign = 'center';
    ctx.fillText(bmi ? bmi.toFixed(1) : '', size/2, size/2 + Math.max(12, size * 0.05));
  }

  function printResults() {
    const name = document.getElementById('name').value.trim() || (currentLang==='ar' ? 'المستخدم' : 'User');
    const age = document.getElementById('age').value.trim();
    const genderVal = document.getElementById('gender').value || '';
    const resultHTML = document.getElementById('result').innerHTML;
    const tipsText = document.getElementById('tips').textContent;
    const t = translations[currentLang];

    // localized gender text
    let genderText = '';
    if (genderVal === 'male') genderText = t.male;
    else if (genderVal === 'female') genderText = t.female;

    const printDiv = document.getElementById('printContent');
    const printBody = document.getElementById('printBody');
    const printHeader = document.getElementById('printHeader');

    document.getElementById('printTitle').textContent = currentLang === 'ar' ? `النتائج الصحية لـ ${name}` : `Health Results for ${name}`;
    document.getElementById('printMeta').textContent = `${genderText ? (currentLang==='ar' ? 'الجنس: ' : 'Gender: ') + genderText : ''} ${age ? ' • ' + (currentLang==='ar' ? 'العمر: ' : 'Age: ') + age : ''}`;
    document.getElementById('printResult').innerHTML = resultHTML;
    document.getElementById('printTips').textContent = tipsText;

    // set print block direction & alignment according to current language (inline, for immediate visual)
    if (currentLang === 'ar') {
      printDiv.dir = 'rtl';
      printDiv.style.textAlign = 'center'; // center block visually
      printBody.style.textAlign = 'right';
      const h2 = printHeader.querySelector('h2');
      if (h2) h2.style.textAlign = 'center';
    } else {
      printDiv.dir = 'ltr';
      printDiv.style.textAlign = 'left';
      printBody.style.textAlign = 'left';
      const h2 = printHeader.querySelector('h2');
      if (h2) h2.style.textAlign = 'left';
    }

    // capture gauge canvas as image
    const gaugeCanvas = document.getElementById('bmiGauge');
    const gaugeImg = document.getElementById('printGaugeImg');
    try {
      const gaugeData = gaugeCanvas.toDataURL('image/png');
      gaugeImg.src = gaugeData;
      gaugeImg.style.display = 'block';
    } catch(e) {
      gaugeImg.style.display = 'none';
    }

    printDiv.style.display = 'block';
    // allow rendering, then print
    setTimeout(() => {
      window.print();
      setTimeout(() => { printDiv.style.display = 'none'; }, 200);
    }, 260);
  }

  function showToast(message, ttl = 1800) {
    const t = document.getElementById('toast');
    t.textContent = message;
    t.style.display = 'block';
    requestAnimationFrame(()=> t.classList.add('show'));
    setTimeout(()=> { t.classList.remove('show'); setTimeout(()=> t.style.display='none', 280); }, ttl);
  }

  function initRipples() {
    document.querySelectorAll('.ripple').forEach(btn => {
      btn.addEventListener('click', function(e){
        const rect = btn.getBoundingClientRect();
        const circle = document.createElement('span');
        const diameter = Math.max(rect.width, rect.height);
        const radius = diameter/2;
        circle.className = 'ripple-effect';
        circle.style.width = circle.style.height = diameter + 'px';
        const left = e.clientX - rect.left - radius;
        const top = e.clientY - rect.top - radius;
        circle.style.left = left + 'px';
        circle.style.top = top + 'px';
        circle.style.backgroundColor = 'rgba(255,255,255,0.22)';
        btn.appendChild(circle);
        setTimeout(()=> circle.remove(), 650);
      });
    });
  }

  window.onload = () => {
    document.documentElement.lang = 'ar';
    document.documentElement.dir = 'rtl';
    setTimeout(()=> { document.getElementById('appContainer').classList.add('animate-ready'); }, 80);
    updateLanguage();
    toggleUnits();
    // draw once on load ensuring size is correct
    setTimeout(() => drawGauge(0), 40);
    initRipples();
    document.getElementById('bmiForm').addEventListener('keydown', function(e){
      if (e.key === 'Enter') { e.preventDefault(); calculateBMI(); }
    });

    // handle window resize to redraw gauge responsively
    window.addEventListener('resize', () => {
      // small debounce
      if (window._bmiResizeTimeout) clearTimeout(window._bmiResizeTimeout);
      window._bmiResizeTimeout = setTimeout(()=> drawGauge(currentGaugeBmi), 80);
    });
  };
</script>

</body>
</html>
